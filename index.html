<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blacnova - Client Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Add PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AU6fuEjjnHJC-tnPDk4dMedZSTV7NulDC-qED1GXztyh_gYhP_nUwxmmbsLs2JYUM0QnS-M_cFYdZUR1&currency=USD"></script>
    <script>
        // Initialize EmailJS with your public key
        (function() {
            emailjs.init("mGAM0CatzjBKJTVe9");
        })();
        
        // Tailwind config
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#d4611c',
                        secondary: '#171717',
                        accent: '#df722d',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc;
        }
        
        .card {
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .client-row:hover {
            background-color: #f1f5f9;
        }
        
        /* Notification styles */
        #notification {
            transition: all 0.3s ease-in-out;
            z-index: 1000;
        }
        
        /* PayPal button container */
        #paypal-button-container {
            margin-top: 15px;
            text-align: center;
        }
        
        /* Invoice status badges */
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="flex justify-between items-center p-4 max-w-7xl mx-auto">
            <div class="flex items-center">
                <img src="https://www.blacnova.net/img/bn.png" alt="Blacnova Development" class="h-8 mr-2">
                <h1 class="text-xl font-semibold text-gray-800">BN-Client Dashboard</h1>
            </div>
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center">
                    <span>AD</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg hidden">
        <span id="notification-message"></span>
    </div>

    <div class="max-w-7xl mx-auto p-4">
        <!-- Stats Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div id="stats-monthly-revenue" class="card bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500">Monthly Revenue</p>
                        <h3 class="text-2xl font-bold text-gray-800">$0</h3>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fas fa-dollar-sign text-primary text-xl"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-sm mt-2"><i class="fas fa-minus"></i> No previous data</p>
            </div>

            <div id="stats-active-clients" class="card bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500">Active Clients</p>
                        <h3 class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-users text-blue-500 text-xl"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-sm mt-2"><i class="fas fa-users"></i> No clients yet</p>
            </div>

            <div id="stats-pending-invoices" class="card bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500">Pending Invoices</p>
                        <h3 class="text-2xl font-bold text-gray-800">0</h3>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <i class="fas fa-file-invoice text-yellow-500 text-xl"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-sm mt-2"><i class="fas fa-file-invoice"></i> No invoices yet</p>
            </div>

            <div id="stats-auto-invoice" class="card bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-gray-500">Auto-Invoice Status</p>
                        <h3 class="text-2xl font-bold text-gray-800">Active</h3>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-check-circle text-green-500 text-xl"></i>
                    </div>
                </div>
                <p class="text-gray-500 text-sm mt-2">Next run: 1st of next month</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-4 mb-8">
            <button onclick="openModal('add-client-modal')" class="bg-primary hover:bg-accent text-white px-6 py-3 rounded-lg flex items-center">
                <i class="fas fa-user-plus mr-2"></i> Add Client
            </button>
            <button onclick="openSendInvoiceModal()" class="bg-primary hover:bg-accent text-white px-6 py-3 rounded-lg flex items-center">
                <i class="fas fa-paper-plane mr-2"></i> Send Invoice
            </button>
            <button onclick="toggleAutoInvoice()" id="auto-invoice-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center">
                <i class="fas fa-robot mr-2"></i> Auto-Invoice: ON
            </button>
            <!-- New "Run in 5 Minutes" button for testing -->
            <button onclick="scheduleTestInvoicing()" id="test-invoice-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg flex items-center">
                <i class="fas fa-bolt mr-2"></i> Run in 5 Minutes
            </button>
        </div>

        <!-- Clients Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Clients</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left border-b">
                            <th class="pb-2">Name</th>
                            <th class="pb-2">Email</th>
                            <th class="pb-2">Service</th>
                            <th class="pb-2">Monthly Fee</th>
                            <th class="pb-2">Status</th>
                            <th class="pb-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body">
                        <!-- Client data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Invoices Section -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Recent Invoices</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left border-b">
                            <th class="pb-2">Invoice #</th>
                            <th class="pb-2">Client</th>
                            <th class="pb-2">Amount</th>
                            <th class="pb-2">Issued</th>
                            <th class="pb-2">Status</th>
                            <th class="pb-2">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoices-table-body">
                        <!-- Invoice data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="add-client-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Add New Client</h3>
            <form id="add-client-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                        <input type="text" id="company-name" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Person</label>
                        <input type="text" id="contact-person" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="client-email" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service</label>
                        <select id="client-service" class="w-full px-4 py-2 border rounded-lg" required>
                            <option value="">Select a service</option>
                            <option value="Web Development">Web Development</option>
                            <option value="SEO Optimization">SEO Optimization</option>
                            <option value="Cloud Solutions">Cloud Solutions</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Fee ($)</label>
                        <input type="number" id="monthly-fee" class="w-full px-4 py-2 border rounded-lg" required min="0" step="0.01">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('add-client-modal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="bg-primary hover:bg-accent text-white px-4 py-2 rounded-lg">Add Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Invoice Modal -->
    <div id="send-invoice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Send Invoice</h3>
            <form id="send-invoice-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Client</label>
                        <select id="invoice-client" class="w-full px-4 py-2 border rounded-lg" required>
                            <option value="">Select a client</option>
                            <!-- Client options will be populated here -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service</label>
                        <input type="text" id="invoice-service" class="w-full px-4 py-2 border rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount ($)</label>
                        <input type="number" id="invoice-amount" class="w-full px-4 py-2 border rounded-lg" required min="0" step="0.01">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeModal('send-invoice-modal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="bg-primary hover:bg-accent text-white px-4 py-2 rounded-lg">Send Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div id="view-invoice-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4">Invoice Details</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500">Invoice #</p>
                    <p id="view-invoice-number" class="font-medium"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Client</p>
                    <p id="view-invoice-client" class="font-medium"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Service</p>
                    <p id="view-invoice-service" class="font-medium"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Amount</p>
                    <p id="view-invoice-amount" class="font-medium"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Issued</p>
                    <p id="view-invoice-issued" class="font-medium"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Status</p>
                    <p id="view-invoice-status" class="font-medium"></p>
                </div>
                <div id="paypal-button-container" class="hidden">
                    <!-- PayPal button will be rendered here -->
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeModal('view-invoice-modal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">Close</button>
            </div>
        </div>
    </div>

    <script>
// Initialize EmailJS with your public key
(function() {
    try {
        emailjs.init('mGAM0CatzjBKJTVe9');
        console.log('EmailJS initialized successfully');
    } catch (error) {
        console.error('EmailJS initialization failed:', error);
    }
})();

// Production-ready data - start with empty arrays
let clients = JSON.parse(localStorage.getItem('clients')) || [];
let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
let autoInvoiceEnabled = JSON.parse(localStorage.getItem('autoInvoiceEnabled')) || true;
let lastMonthRevenue = JSON.parse(localStorage.getItem('lastMonthRevenue')) || 0;
let testInvoiceTimer = null; // For the 5-minute test functionality

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    loadClients();
    loadInvoices();
    updateAutoInvoiceButton();
    updateStats(); // Calculate and display accurate stats
    
    // Set up form handlers
    document.getElementById('add-client-form').addEventListener('submit', handleAddClient);
    document.getElementById('send-invoice-form').addEventListener('submit', handleSendInvoice);
    
    // Set up automatic monthly invoicing
    scheduleMonthlyInvoicing();
    
    // Check for overdue invoices daily
    checkOverdueInvoices();
});

// Calculate and update statistics - FIXED with proper element selection
function updateStats() {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    // Calculate monthly revenue (sum of all paid invoices from this month)
    const monthlyRevenue = invoices
        .filter(invoice => {
            const invoiceDate = new Date(invoice.issued);
            return invoice.status === 'paid' && 
                   invoiceDate.getMonth() === currentMonth && 
                   invoiceDate.getFullYear() === currentYear;
        })
        .reduce((sum, invoice) => sum + invoice.amount, 0);
    
    // Calculate percentage change from last month (only if we have data)
    let revenueChange = 0;
    let revenueChangeText = 'No previous data';
    let revenueChangeIcon = 'minus';
    let revenueChangeColor = 'gray';
    
    if (lastMonthRevenue > 0 && monthlyRevenue > 0) {
        revenueChange = ((monthlyRevenue - lastMonthRevenue) / lastMonthRevenue * 100);
        revenueChangeText = `${Math.abs(revenueChange.toFixed(0))}% from last month`;
        revenueChangeIcon = revenueChange >= 0 ? 'up' : 'down';
        revenueChangeColor = revenueChange >= 0 ? 'green' : 'red';
    } else if (monthlyRevenue > 0) {
        revenueChangeText = 'First month of data';
        revenueChangeIcon = 'plus';
        revenueChangeColor = 'blue';
    }
    
    // Count active clients
    const activeClients = clients.filter(client => client.status === 'active').length;
    
    // Count new clients this month (joined in current month)
    const newClientsThisMonth = clients.filter(client => {
        if (!client.joinDate) return false;
        const joinDate = new Date(client.joinDate);
        return joinDate.getMonth() === currentMonth && joinDate.getFullYear() === currentYear;
    }).length;
    
    // Count pending and overdue invoices
    const pendingInvoices = invoices.filter(invoice => invoice.status === 'pending').length;
    const overdueInvoices = invoices.filter(invoice => invoice.status === 'overdue').length;
    const totalPendingInvoices = pendingInvoices + overdueInvoices;
    
    // Update the stats display - using the correct element structure
    const revenueElement = document.querySelector('#stats-monthly-revenue h3');
    const revenueChangeElement = document.querySelector('#stats-monthly-revenue p:last-child');
    const clientsElement = document.querySelector('#stats-active-clients h3');
    const clientsChangeElement = document.querySelector('#stats-active-clients p:last-child');
    const invoicesElement = document.querySelector('#stats-pending-invoices h3');
    const invoicesChangeElement = document.querySelector('#stats-pending-invoices p:last-child');
    const autoInvoiceElement = document.querySelector('#stats-auto-invoice p:last-child');
    
    if (revenueElement) revenueElement.textContent = `$${monthlyRevenue.toLocaleString()}`;
    if (revenueChangeElement) {
        revenueChangeElement.innerHTML = `<i class="fas fa-${revenueChangeIcon}"></i> ${revenueChangeText}`;
        revenueChangeElement.className = `text-${revenueChangeColor}-500 text-sm mt-2`;
    }
    
    if (clientsElement) clientsElement.textContent = activeClients;
    if (clientsChangeElement) {
        if (newClientsThisMonth > 0) {
            clientsChangeElement.innerHTML = `<i class="fas fa-arrow-up"></i> ${newClientsThisMonth} new this month`;
            clientsChangeElement.className = 'text-green-500 text-sm mt-2';
        } else if (activeClients > 0) {
            clientsChangeElement.innerHTML = `<i class="fas fa-minus"></i> No new clients this month`;
            clientsChangeElement.className = 'text-gray-500 text-sm mt-2';
        } else {
            clientsChangeElement.innerHTML = `<i class="fas fa-users"></i> No clients yet`;
            clientsChangeElement.className = 'text-gray-500 text-sm mt-2';
        }
    }
    
    if (invoicesElement) invoicesElement.textContent = totalPendingInvoices;
    if (invoicesChangeElement) {
        if (overdueInvoices > 0) {
            invoicesChangeElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${overdueInvoices} overdue`;
            invoicesChangeElement.className = 'text-red-500 text-sm mt-2';
        } else if (pendingInvoices > 0) {
            invoicesChangeElement.innerHTML = `<i class="fas fa-clock"></i> ${pendingInvoices} pending`;
            invoicesChangeElement.className = 'text-yellow-500 text-sm mt-2';
        } else if (invoices.length > 0) {
            invoicesChangeElement.innerHTML = `<i class="fas fa-check"></i> All invoices paid`;
            invoicesChangeElement.className = 'text-green-500 text-sm mt-2';
        } else {
            invoicesChangeElement.innerHTML = `<i class="fas fa-file-invoice"></i> No invoices yet`;
            invoicesChangeElement.className = 'text-gray-500 text-sm mt-2';
        }
    }
    
    // Update auto-invoice status
    if (autoInvoiceElement) {
        const nextRunDate = new Date();
        nextRunDate.setMonth(nextRunDate.getMonth() + 1);
        nextRunDate.setDate(1);
        autoInvoiceElement.textContent = `Next run: ${formatDate(nextRunDate.toISOString().split('T')[0])}`;
    }
}

// Check for overdue invoices
function checkOverdueInvoices() {
    const today = new Date();
    let updated = false;
    
    invoices.forEach(invoice => {
        if (invoice.status === 'pending') {
            const dueDate = new Date(invoice.dueDate);
            if (dueDate < today) {
                invoice.status = 'overdue';
                updated = true;
            }
        }
    });
    
    if (updated) {
        localStorage.setItem('invoices', JSON.stringify(invoices));
        loadInvoices();
        updateStats();
    }
}

// Load clients into the table
function loadClients() {
    const tableBody = document.getElementById('clients-table-body');
    tableBody.innerHTML = '';
    
    if (clients.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" class="py-8 text-center text-gray-500">
                <i class="fas fa-users text-3xl mb-2"></i>
                <p>No clients found. Add your first client to get started.</p>
            </td>
        `;
        tableBody.appendChild(row);
        return;
    }
    
    clients.forEach(client => {
        const row = document.createElement('tr');
        row.className = 'client-row border-b';
        row.innerHTML = `
            <td class="py-3">
                <div class="font-medium">${client.company}</div>
                <div class="text-sm text-gray-500">${client.contact}</div>
            </td>
            <td class="py-3">${client.email}</td>
            <td class="py-3">${client.service}</td>
            <td class="py-3">$${client.monthlyFee}</td>
            <td class="py-3">
                <span class="status-badge ${client.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${client.status}
                </span>
            </td>
            <td class="py-3">
                <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="editClient(${client.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-600 hover:text-red-800" onclick="deleteClient(${client.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Load invoices into the table
function loadInvoices() {
    const tableBody = document.getElementById('invoices-table-body');
    tableBody.innerHTML = '';
    
    if (invoices.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" class="py-8 text-center text-gray-500">
                <i class="fas fa-file-invoice text-3xl mb-2"></i>
                <p>No invoices found. Send your first invoice to get started.</p>
            </td>
        `;
        tableBody.appendChild(row);
        return;
    }
    
    // Show only the 5 most recent invoices
    const recentInvoices = [...invoices].sort((a, b) => new Date(b.issued) - new Date(a.issued)).slice(0, 5);
    
    recentInvoices.forEach(invoice => {
        const row = document.createElement('tr');
        row.className = 'border-b';
        row.innerHTML = `
            <td class="py-3">#${invoice.id}</td>
            <td class="py-3">${invoice.clientName}</td>
            <td class="py-3">$${invoice.amount}</td>
            <td class="py-3">${formatDate(invoice.issued)}</td>
            <td class="py-3">
                <span class="status-badge ${invoice.status === 'paid' ? 'bg-green-100 text-green-800' : 
                    invoice.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                    ${invoice.status}
                </span>
            </td>
            <td class="py-3">
                <button class="text-blue-600 hover:text-blue-800" onclick="viewInvoice(${invoice.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Populate client dropdown
function populateClientDropdown() {
    const dropdown = document.getElementById('invoice-client');
    // Clear all options
    dropdown.innerHTML = '<option value="">Select a client</option>';
    
    if (clients.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "No active clients available";
        option.disabled = true;
        dropdown.appendChild(option);
        return;
    }
    
    // Add client options
    clients.forEach(client => {
        if (client.status === 'active') {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = `${client.company} (${client.contact})`;
            option.setAttribute('data-service', client.service);
            option.setAttribute('data-fee', client.monthlyFee);
            option.setAttribute('data-email', client.email);
            dropdown.appendChild(option);
        }
    });
    
    // Add event listener to auto-fill service and amount
    dropdown.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            document.getElementById('invoice-service').value = selectedOption.getAttribute('data-service');
            document.getElementById('invoice-amount').value = selectedOption.getAttribute('data-fee');
        }
    });
}

// Open send invoice modal with populated clients
function openSendInvoiceModal() {
    populateClientDropdown();
    openModal('send-invoice-modal');
}

// Handle add client form submission
function handleAddClient(e) {
    e.preventDefault();
    
    const newClient = {
        id: clients.length > 0 ? Math.max(...clients.map(c => c.id)) + 1 : 1,
        company: document.getElementById('company-name').value,
        contact: document.getElementById('contact-person').value,
        email: document.getElementById('client-email').value,
        service: document.getElementById('client-service').value,
        monthlyFee: parseFloat(document.getElementById('monthly-fee').value),
        status: "active",
        joinDate: new Date().toISOString().split('T')[0]
    };
    
    clients.push(newClient);
    localStorage.setItem('clients', JSON.stringify(clients));
    
    loadClients();
    updateStats(); // Update stats to reflect new client
    e.target.reset();
    closeModal('add-client-modal');
    
    showNotification('Client added successfully!', 'success');
}

// Handle send invoice form submission
function handleSendInvoice(e) {
    e.preventDefault();
    
    const clientId = parseInt(document.getElementById('invoice-client').value);
    const client = clients.find(c => c.id === clientId);
    
    if (!client) {
        showNotification('Please select a valid client.', 'error');
        return;
    }
    
    const service = document.getElementById('invoice-service').value;
    const amount = parseFloat(document.getElementById('invoice-amount').value);
    
    const newInvoice = {
        id: invoices.length > 0 ? Math.max(...invoices.map(i => i.id)) + 1 : 1001,
        clientId: clientId,
        clientName: client.company,
        amount: amount,
        issued: new Date().toISOString().split('T')[0],
        dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 14 days from now
        status: "pending",
        service: service
    };
    
    invoices.push(newInvoice);
    localStorage.setItem('invoices', JSON.stringify(invoices));
    
    // Send invoice via EmailJS
    sendEmail(client, newInvoice);
    
    loadInvoices();
    updateStats(); // Update stats to reflect new invoice
    e.target.reset();
    closeModal('send-invoice-modal');
    
    showNotification('Invoice sent successfully!', 'success');
}

// Send invoice email using EmailJS
function sendEmail(client, invoice) {
    // Check if client email is valid
    if (!client.email || client.email.trim() === '') {
        console.error('Recipient email is empty');
        showNotification('Failed to send email: Recipient email is empty', 'error');
        return;
    }
    
    // Use the exact parameter format from your working code
    const emailParams = {
        email: client.email,
        from_name: 'Blacnova Development',
        customerName: client.contact,
        invoiceNumber: invoice.id,
        dateIssued: formatDate(invoice.issued),
        service: invoice.service,
        price: invoice.amount.toFixed(2),
        dueDate: formatDate(invoice.dueDate)
    };
    
    console.log('Sending email with params:', emailParams);
    
    emailjs.send('service_g3x1dzf', 'template_ptf2tzg', emailParams)
        .then((response) => {
            console.log('Email sent successfully!', response.status, response.text);
            showNotification('Email sent successfully!', 'success');
        })
        .catch((error) => {
            console.error('Failed to send email:', error);
            if (error.text) {
                console.error('Error details:', error.text);
            }
            showNotification('Failed to send email. Please check console for details.', 'error');
        });
}

// View invoice details
function viewInvoice(invoiceId) {
    const invoice = invoices.find(i => i.id === invoiceId);
    if (!invoice) return;
    
    document.getElementById('view-invoice-number').textContent = invoice.id;
    document.getElementById('view-invoice-client').textContent = invoice.clientName;
    document.getElementById('view-invoice-service').textContent = invoice.service;
    document.getElementById('view-invoice-amount').textContent = '$' + invoice.amount;
    document.getElementById('view-invoice-issued').textContent = formatDate(invoice.issued);
    
    const statusElement = document.getElementById('view-invoice-status');
    statusElement.textContent = invoice.status;
    statusElement.className = 'font-medium ' + 
        (invoice.status === 'paid' ? 'text-green-600' : 
         invoice.status === 'pending' ? 'text-yellow-600' : 'text-red-600');
    
    // Show PayPal button only for pending invoices
    const paypalContainer = document.getElementById('paypal-button-container');
    paypalContainer.innerHTML = '';
    
    if (invoice.status === 'pending' || invoice.status === 'overdue') {
        paypalContainer.classList.remove('hidden');
        renderPayPalButton(invoice);
    } else {
        paypalContainer.classList.add('hidden');
    }
    
    openModal('view-invoice-modal');
}

// Render PayPal button for invoice payment
function renderPayPalButton(invoice) {
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: invoice.amount.toFixed(2)
                    },
                    description: `Invoice #${invoice.id} - ${invoice.service}`
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                // Update invoice status to paid
                invoice.status = 'paid';
                invoice.paidDate = new Date().toISOString().split('T')[0];
                localStorage.setItem('invoices', JSON.stringify(invoices));
                loadInvoices();
                updateStats(); // Update stats to reflect payment
                
                showNotification('Payment completed successfully!', 'success');
                
                // Close the modal after a short delay
                setTimeout(() => {
                    closeModal('view-invoice-modal');
                }, 1500);
            });
        },
        onError: function(err) {
            console.error('PayPal error:', err);
            showNotification('An error occurred with the payment. Please try again.', 'error');
        }
    }).render('#paypal-button-container');
}

// Delete client
function deleteClient(clientId) {
    if (confirm('Are you sure you want to delete this client?')) {
        clients = clients.filter(c => c.id !== clientId);
        localStorage.setItem('clients', JSON.stringify(clients));
        
        // Also delete any invoices for this client
        invoices = invoices.filter(i => i.clientId !== clientId);
        localStorage.setItem('invoices', JSON.stringify(invoices));
        
        loadClients();
        loadInvoices();
        updateStats(); // Update stats to reflect changes
        
        showNotification('Client deleted successfully!', 'success');
    }
}

// Toggle auto invoice
function toggleAutoInvoice() {
    autoInvoiceEnabled = !autoInvoiceEnabled;
    localStorage.setItem('autoInvoiceEnabled', JSON.stringify(autoInvoiceEnabled));
    updateAutoInvoiceButton();
    
    showNotification(`Auto-invoice ${autoInvoiceEnabled ? 'enabled' : 'disabled'}`, 'success');
}

function updateAutoInvoiceButton() {
    const btn = document.getElementById('auto-invoice-btn');
    if (autoInvoiceEnabled) {
        btn.innerHTML = '<i class="fas fa-robot mr-2"></i> Auto-Invoice: ON';
        btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        btn.classList.add('bg-green-600', 'hover:bg-green-700');
    } else {
        btn.innerHTML = '<i class="fas fa-robot mr-2"></i> Auto-Invoice: OFF';
        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
        btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
    }
}

// Schedule automatic monthly invoicing
function scheduleMonthlyInvoicing() {
    // Check if it's the first day of the month and auto invoice is enabled
    const today = new Date();
    if (today.getDate() === 1 && autoInvoiceEnabled) {
        sendMonthlyInvoices();
    }
    
    // Check every hour if it's the first of the month
    setInterval(() => {
        const now = new Date();
        if (now.getDate() === 1 && now.getHours() === 0 && now.getMinutes() === 0 && autoInvoiceEnabled) {
            sendMonthlyInvoices();
        }
    }, 60 * 60 * 1000); // Check every hour
}

// Send invoices to all active clients on the 1st of the month
function sendMonthlyInvoices() {
    // Save last month's revenue before creating new invoices
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    const monthlyRevenue = invoices
        .filter(invoice => {
            const invoiceDate = new Date(invoice.issued);
            return invoice.status === 'paid' && 
                   invoiceDate.getMonth() === currentMonth && 
                   invoiceDate.getFullYear() === currentYear;
        })
        .reduce((sum, invoice) => sum + invoice.amount, 0);
    
    lastMonthRevenue = monthlyRevenue;
    localStorage.setItem('lastMonthRevenue', JSON.stringify(lastMonthRevenue));
    
    // Create invoices for all active clients
    clients.forEach(client => {
        if (client.status === 'active') {
            const invoiceId = invoices.length > 0 ? Math.max(...invoices.map(i => i.id)) + 1 : 1001;
            const today = new Date().toISOString().split('T')[0];
            
            const newInvoice = {
                id: invoiceId,
                clientId: client.id,
                clientName: client.company,
                amount: client.monthlyFee,
                issued: today,
                dueDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 14 days from now
                status: "pending",
                service: client.service
            };
            
            invoices.push(newInvoice);
            
            // Send email
            sendEmail(client, newInvoice);
        }
    });
    
    localStorage.setItem('invoices', JSON.stringify(invoices));
    loadInvoices();
    updateStats();
    
    showNotification('Monthly invoices sent to all active clients.', 'success');
}

// NEW FUNCTION: Schedule test invoicing in 5 minutes
function scheduleTestInvoicing() {
    // Clear any existing timer
    if (testInvoiceTimer) {
        clearTimeout(testInvoiceTimer);
    }
    
    // Calculate 5 minutes from now
    const fiveMinutesFromNow = new Date(Date.now() + 5 * 60 * 1000);
    
    // Update the button to show the countdown
    const btn = document.getElementById('test-invoice-btn');
    const originalText = btn.innerHTML;
    
    // Show initial countdown
    btn.innerHTML = '<i class="fas fa-bolt mr-2"></i> Running in 5:00';
    btn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
    btn.disabled = true;
    
    showNotification('Test invoicing scheduled to run in 5 minutes.', 'info');
    
    // Start countdown
    let secondsLeft = 300; // 5 minutes in seconds
    const countdownInterval = setInterval(() => {
        secondsLeft--;
        const minutes = Math.floor(secondsLeft / 60);
        const seconds = secondsLeft % 60;
        
        btn.innerHTML = `<i class="fas fa-bolt mr-2"></i> Running in ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        if (secondsLeft <= 0) {
            clearInterval(countdownInterval);
        }
    }, 1000);
    
    // Set the actual function to run after 5 minutes
    testInvoiceTimer = setTimeout(() => {
        // Clear the interval when time is up
        clearInterval(countdownInterval);
        
        // Run the monthly invoicing function
        sendMonthlyInvoices();
        
        // Reset the button
        btn.innerHTML = originalText;
        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        btn.classList.add('bg-purple-600', 'hover:bg-purple-700');
        btn.disabled = false;
        
        showNotification('Test invoicing completed successfully!', 'success');
    }, 5 * 60 * 1000); // 5 minutes
}

// Format date for display
function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    const messageEl = document.getElementById('notification-message');
    
    // Remove previous classes
    notification.classList.remove('bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');
    
    // Set new classes based on type
    switch(type) {
        case 'success':
            notification.classList.add('bg-green-500', 'text-white');
            break;
        case 'error':
            notification.classList.add('bg-red-500', 'text-white');
            break;
        case 'warning':
            notification.classList.add('bg-yellow-500', 'text-black');
            break;
        default:
            notification.classList.add('bg-blue-500', 'text-white');
    }
    
    messageEl.textContent = message;
    notification.classList.remove('hidden');
    
    // Auto hide after 3 seconds
    setTimeout(() => {
        notification.classList.add('hidden');
    }, 3000);
}

// Modal functions
function openModal(id) {
    document.getElementById(id).classList.remove('hidden');
}

function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

// Close modals when clicking outside
document.querySelectorAll('[id$="-modal"]').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal(modal.id);
        }
    });
});

// Edit client function (needed for the client table)
function editClient(clientId) {
    // Find the client
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    // Populate the form
    document.getElementById('company-name').value = client.company;
    document.getElementById('contact-person').value = client.contact;
    document.getElementById('client-email').value = client.email;
    document.getElementById('client-service').value = client.service;
    document.getElementById('monthly-fee').value = client.monthlyFee;
    
    // Remove the old client
    clients = clients.filter(c => c.id !== clientId);
    
    // Open the modal
    openModal('add-client-modal');
    
    // Change the form submit handler to handle editing
    const form = document.getElementById('add-client-form');
    const originalSubmitHandler = form.onsubmit;
    form.onsubmit = function(e) {
        e.preventDefault();
        
        // Update the client
        const updatedClient = {
            id: clientId,
            company: document.getElementById('company-name').value,
            contact: document.getElementById('contact-person').value,
            email: document.getElementById('client-email').value,
            service: document.getElementById('client-service').value,
            monthlyFee: parseFloat(document.getElementById('monthly-fee').value),
            status: client.status,
            joinDate: client.joinDate
        };
        
        clients.push(updatedClient);
        localStorage.setItem('clients', JSON.stringify(clients));
        
        loadClients();
        updateStats();
        form.reset();
        closeModal('add-client-modal');
        
        // Restore the original submit handler
        form.onsubmit = originalSubmitHandler;
        
        showNotification('Client updated successfully!', 'success');
    };
}
    </script>
</body>
</html>